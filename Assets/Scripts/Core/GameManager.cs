using UnityEngine;
using System.Collections;
using CrescentWreath.Modules; // å¼•ç”¨æ¨¡å—
using CrescentWreath.View;    // å¼•ç”¨è§†è§‰

namespace CrescentWreath.Core
{
    /// <summary>
    /// æ¸¸æˆæµç¨‹æ€»å¯¼æ¼”
    /// èŒè´£ï¼šæ§åˆ¶æ¸¸æˆå¯åŠ¨é¡ºåºã€å›åˆæµè½¬ã€é˜¶æ®µåˆ‡æ¢ã€‚
    /// å®ƒä¸æŒæœ‰æ•°æ®ï¼Œå®ƒåªè´Ÿè´£è°ƒç”¨ Modules çš„èƒ½åŠ›ã€‚
    /// </summary>
    public class GameManager : MonoBehaviour
    {
        [Header("--- æ ¸å¿ƒæ¨¡å—è¿æ¥ ---")]
        [Tooltip("è´Ÿè´£æ¡Œé¢çš„æ•°æ®ï¼ˆå¬å”¤åŒºã€å¼‚å˜ã€æ¨±èŠ±é¥¼ï¼‰")]
        public TableZoneModule tableModule;
        
        [Tooltip("è´Ÿè´£è§†è§‰è¡¨ç°ï¼ˆç”Ÿæˆæ¨¡å‹ã€é£å¡ç‰Œï¼‰")]
        public GameVisualManager visualManager;
        
        [Tooltip("è´Ÿè´£å›åˆé€»è¾‘")]
        public TurnModule turnModule;
        
        // å¦‚æœæœ‰ PlayerZoneModule ä¹Ÿåœ¨è¿™é‡Œå¼•ç”¨
        // public PlayerZoneModule playerModule;

        private void Start()
        {
            // æ¸¸æˆå¯åŠ¨ï¼Œå¤§å¹•æ‹‰å¼€
            StartCoroutine(GameStartFlow());
        }

        /// <summary>
        /// ã€å‰§æœ¬ã€‘æ¸¸æˆå¯åŠ¨æµç¨‹
        /// è¿™é‡Œå®šä¹‰äº†å‘ç”Ÿçš„ä¸€åˆ‡äº‹æƒ…çš„é¡ºåºå’ŒèŠ‚å¥
        /// </summary>
        private IEnumerator GameStartFlow()
        {
            Debug.Log("<color=yellow>ğŸ¬ [Director] æ¸¸æˆå¯åŠ¨æµç¨‹å¼€å§‹...</color>");

            // =============================================================
            // ç¬¬ä¸€å¹•ï¼šæ•°æ®çš„åˆ›ç”Ÿ
            // =============================================================
            // å¿…é¡»æœ€å…ˆæ‰§è¡Œï¼å…ˆæŠŠ List å¡«æ»¡ï¼ŒæŠŠç‰Œåº“æ´—å¥½ã€‚
            // åªæœ‰æ•°æ®å‡†å¤‡å¥½äº†ï¼Œè§†è§‰å±‚æ‰èƒ½çŸ¥é“è¦åœ¨å“ªé‡Œç”Ÿæˆå¤šåšçš„ç‰Œå †ã€‚
            tableModule.InitializeTable();
            // playerModule.Initialize(); 
            
            Debug.Log($"[Director] æ•°æ®å±‚æ„å»ºå®Œæ¯•ã€‚ä¸»ç‰Œåº“å‰©ä½™: {tableModule.GetRelicDeckCount()} å¼ ");

            // =============================================================
            // ç¬¬äºŒå¹•ï¼šèˆå°çš„æ­å»º
            // =============================================================
            // ç°åœ¨æ•°æ®æœ‰äº†ï¼Œè®© VisualManager è¿›åœºï¼Œæ ¹æ®æ•°æ®åœ¨æ¡Œä¸Šæ‘†æ”¾é™æ­¢çš„ç‰Œå †æ¨¡å‹
            visualManager.InitializeDecks();
            
            Debug.Log("[Director] è§†è§‰èˆå°æ­å»ºå®Œæ¯•ã€‚");
            yield return new WaitForSeconds(0.5f); // ç¨å¾®åœé¡¿ï¼Œå±•ç¤ºä¸€ä¸‹ç©ºæ—·çš„æ¡Œé¢

            // =============================================================
            // ç¬¬ä¸‰å¹•ï¼šå¬å”¤ä»ªå¼ (ä»ç‰Œåº“å‘ 6 å¼ ç‰Œåˆ°ä¸­é—´)
            // =============================================================
            Debug.Log("[Director] å¼€å§‹å¡«å……å¬å”¤åŒº...");
            
            for (int i = 0; i < 6; i++)
            {
                // æŒ‡æŒ¥ TableModuleï¼šä»ç‰Œå †é¡¶æŠ½ä¸€å¼ ï¼Œæ”¾åˆ°ç¬¬ i ä¸ªæ ¼å­é‡Œ
                // TableModule ä¼šä¿®æ”¹æ•°æ®ï¼Œå¹¶å¹¿æ’­äº‹ä»¶ï¼Œè®© VisualManager ç”Ÿæˆé£è¡ŒåŠ¨ç”»
                tableModule.DrawCardToSummonSlot(i);
                
                // èŠ‚å¥æ§åˆ¶ï¼šæ¯ 0.15 ç§’å‘ä¸€å¼ ï¼Œåˆ¶é€ â€œåˆ·ã€åˆ·ã€åˆ·â€çš„èŠ‚å¥æ„Ÿ
                yield return new WaitForSeconds(0.15f);
            }
            
            yield return new WaitForSeconds(0.8f); // ç­‰å¾…æ‰€æœ‰å¡ç‰Œé£åˆ°ä½

            // =============================================================
            // ç¬¬å››å¹•ï¼šå¼‚å˜çš„é™ä¸´
            // =============================================================
            Debug.Log("[Director] æ­ç¤ºé¦–ä¸ªå¼‚å˜...");
            
            // ç¿»å¼€ç¬¬ä¸€å¼ å¼‚å˜å¡
            // åŒæ ·ï¼Œè¿™ä¼šè§¦å‘å¹¿æ’­ï¼Œè®©å¼‚å˜å¡ä»çº¢è‰²åŒºåŸŸç¿»å¼€é£å‡ºæ¥
            tableModule.RevealTopAnomaly();
            
            yield return new WaitForSeconds(1.0f);

            // =============================================================
            // ç¬¬äº”å¹•ï¼šç©å®¶å…¥åœº
            // =============================================================
            Debug.Log("[Director] ç©å®¶æŠ½å–åˆå§‹æ‰‹ç‰Œ...");
            
            // å‡è®¾æˆ‘ä»¬è¦ç»™ Player 0 (ä½ è‡ªå·±) å‘ 5 å¼ ç‰Œ
            // è¿™é‡Œçš„ä»£ç éœ€è¦ä½ çš„ PlayerZoneModule æ”¯æŒï¼Œæš‚æ—¶ç”¨æ³¨é‡Šè¡¨ç¤º
            /*
            for (int i = 0; i < 5; i++)
            {
                playerModule.DrawCard(0); // ç©å®¶0æŠ½ç‰Œ
                yield return new WaitForSeconds(0.1f);
            }
            */

            // =============================================================
            // ç»ˆå¹•ï¼šæ¸¸æˆæ­£å¼å¼€å§‹
            // =============================================================
            Debug.Log("<color=cyan>âœ¨ [Director] æ‰€æœ‰å‡†å¤‡å·¥ä½œå°±ç»ªï¼Œæ¸¸æˆå¼€å§‹ï¼</color>");
            
            // è½¬äº¤æ§åˆ¶æƒç»™ TurnModuleï¼Œå¼€å§‹ç¬¬ä¸€å›åˆ
            if (turnModule != null)
            {
                turnModule.StartGame();
            }
        }
    }
}